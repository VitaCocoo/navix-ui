<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>药店智能决策 - 运营指挥舱</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 主品牌色梯度
                        'primary': {
                            1: '#E8F4FD',
                            2: '#BEE3F8',
                            3: '#90CDF4',
                            4: '#63B3ED',
                            5: '#4299E1',
                            6: '#3182CE',
                            7: '#2D7DD2',
                            8: '#2C5AA0',
                            9: '#1A365D',
                            10: '#0D1B2E',
                            DEFAULT: '#4299E1',
                            'hover': '#3182CE',
                            'active': '#2D7DD2',
                        },
                        // 辅助色
                        'secondary': {
                            'teal': '#2EC4B6',
                            'teal-bg': 'rgba(46, 196, 182, 0.1)',
                            'orange': '#FF9F1C',
                            'purple': '#9F7AEA',
                            'pink': '#ED64A6',
                        },
                        // 功能色
                        'success': {
                            DEFAULT: '#48BB78',
                            'bg': '#F0FFF4',
                            'border': '#9AE6B4',
                        },
                        'warning': {
                            DEFAULT: '#ECC94B',
                            'text': '#D69E2E',
                            'bg': '#FFFBEB',
                            'border': '#F6E05E',
                        },
                        'error': {
                            DEFAULT: '#F56565',
                            'bg': '#FFF5F5',
                            'border': '#FEB2B2',
                        },
                        'info': {
                            DEFAULT: '#4299E1',
                            'bg': '#E8F4FD',
                            'border': '#90CDF4',
                        },
                        // 文字颜色
                        'text': {
                            'primary': '#2D3748',
                            'secondary': '#4A5568',
                            'tertiary': '#718096',
                            'disabled': '#A0AEC0',
                            'inverse': '#FFFFFF',
                        },
                        // 背景颜色
                        'bg': {
                            'base': '#FFFFFF',
                            'light': '#F7FAFC',
                            'container': '#EDF2F7',
                            'hover': '#E2E8F0',
                        },
                        // 边框颜色
                        'border': {
                            'base': '#E2E8F0',
                            'light': '#EDF2F7',
                            'split': '#F7FAFC',
                        },
                        // 中性灰度
                        'gray': {
                            100: '#F7FAFC',
                            300: '#E2E8F0',
                            500: '#718096',
                            700: '#4A5568',
                            900: '#2D3748',
                        },
                        // 图表色彩
                        'chart': {
                            'blue': '#2D7DD2',
                            'orange': '#FF9F1C',
                            'teal': '#2EC4B6',
                            'purple': '#9F7AEA',
                            'pink': '#ED64A6',
                            'green': '#68D391',
                        },
                    },
                    boxShadow: {
                        'card': '0 2px 8px rgba(0, 0, 0, 0.08)',
                        'hover': '0 4px 16px rgba(0, 0, 0, 0.12)',
                        'modal': '0 12px 32px rgba(0, 0, 0, 0.16)',
                    },
                    fontFamily: {
                        'sans': ['Microsoft YaHei', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ===== CSS Variables 色彩系统 ===== */
        :root {
            /* 主品牌色梯度 */
            --primary-1: #E8F4FD;
            --primary-2: #BEE3F8;
            --primary-3: #90CDF4;
            --primary-4: #63B3ED;
            --primary-5: #4299E1;
            --primary-6: #3182CE;
            --primary-7: #2D7DD2;
            --primary-8: #2C5AA0;
            --primary-9: #1A365D;
            --primary-10: #0D1B2E;
            
            /* 主要交互色 */
            --primary-color: #4299E1;
            --primary-hover: #3182CE;
            --primary-active: #2D7DD2;
            
            /* 辅助色 */
            --secondary-teal: #2EC4B6;
            --secondary-teal-bg: rgba(46, 196, 182, 0.1);
            --secondary-orange: #FF9F1C;
            --secondary-purple: #9F7AEA;
            --secondary-pink: #ED64A6;
            
            /* 功能色 */
            --success-color: #48BB78;
            --success-bg: #F0FFF4;
            --success-border: #9AE6B4;
            
            --warning-color: #ECC94B;
            --warning-text: #D69E2E;
            --warning-bg: #FFFBEB;
            --warning-border: #F6E05E;
            
            --error-color: #F56565;
            --error-bg: #FFF5F5;
            --error-border: #FEB2B2;
            
            --info-color: #4299E1;
            --info-bg: #E8F4FD;
            --info-border: #90CDF4;
            
            --disabled-color: #E2E8F0;
            
            /* 文字颜色 */
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --text-tertiary: #718096;
            --text-disabled: #A0AEC0;
            --text-inverse: #FFFFFF;
            
            /* 背景颜色 */
            --bg-base: #FFFFFF;
            --bg-light: #F7FAFC;
            --bg-container: #EDF2F7;
            --bg-hover: #E2E8F0;
            
            /* 边框颜色 */
            --border-base: #E2E8F0;
            --border-light: #EDF2F7;
            --border-split: #F7FAFC;
            
            /* 中性灰度 */
            --gray-100: #F7FAFC;
            --gray-300: #E2E8F0;
            --gray-500: #718096;
            --gray-700: #4A5568;
            --gray-900: #2D3748;
            
            /* 图表色彩 */
            --chart-blue: #2D7DD2;
            --chart-orange: #FF9F1C;
            --chart-teal: #2EC4B6;
            --chart-purple: #9F7AEA;
            --chart-pink: #ED64A6;
            --chart-green: #68D391;
            
            /* 阴影 */
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-modal: 0 12px 32px rgba(0, 0, 0, 0.16);
            
            /* ===== 渐变色定义 ===== */
            /* 主要渐变 */
            --gradient-primary: linear-gradient(135deg, #4299E1 0%, #2C5AA0 100%);
            --gradient-accent: linear-gradient(135deg, #4299E1 0%, #2EC4B6 100%);
            --gradient-success: linear-gradient(135deg, #48BB78 0%, #38A169 100%);
            --gradient-warning: linear-gradient(135deg, #FF9F1C 0%, #ECC94B 100%);
            
            /* 装饰性渐变 */
            --gradient-bg: linear-gradient(180deg, #F7FAFC 0%, #FFFFFF 100%);
            --gradient-card: linear-gradient(135deg, rgba(66, 153, 225, 0.05) 0%, rgba(255, 255, 255, 1) 100%);
            --gradient-topbar: linear-gradient(90deg, #FFFFFF 0%, #E8F4FD 100%);
            --gradient-divider: linear-gradient(90deg, transparent 0%, #4299E1 50%, transparent 100%);
            
            /* 数据可视化渐变 */
            --gradient-chart-fill: linear-gradient(180deg, rgba(66, 153, 225, 0.2) 0%, rgba(66, 153, 225, 0.05) 100%);
            --gradient-chart-blue: linear-gradient(135deg, #90CDF4 0%, #2D7DD2 100%);
            --gradient-chart-orange: linear-gradient(135deg, #FFA94D 0%, #FF9F1C 100%);
            --gradient-chart-teal: linear-gradient(135deg, #81E6D9 0%, #2EC4B6 100%);
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-primary);
            font-family: 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        /* 卡片面板 */
        .glass-panel {
            background: var(--gradient-card);
            border: 1px solid var(--border-base);
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
        }
        
        .glass-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
        
        /* 图表容器 */
        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
            overflow: hidden;
        }
        
        /* 固定顶部标签栏 */
        .sticky-tabs {
            position: sticky;
            top: 0;
            z-index: 40;
            background: var(--bg-base);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--border-light);
        }
        
        /* 禁用横向滚动条显示 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* ===== 渐变色应用样式 ===== */
        
        /* 主按钮渐变 */
        .btn-gradient-primary {
            background: var(--gradient-primary);
            color: var(--text-inverse);
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }
        
        .btn-gradient-primary:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-gradient-primary:active {
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.4);
            transform: translateY(0);
        }
        
        /* 强调渐变卡片 */
        .card-gradient-accent {
            background: var(--gradient-accent);
            color: var(--text-inverse);
            border: none;
            transition: all 0.3s ease;
        }
        
        .card-gradient-accent:hover {
            filter: brightness(1.05);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(66, 153, 225, 0.25);
        }
        
        /* 成功渐变元素 */
        .gradient-success {
            background: var(--gradient-success);
        }
        
        /* 装饰性渐变分隔线 */
        .gradient-divider {
            height: 2px;
            background: var(--gradient-divider);
            border: none;
            margin: 16px 0;
        }
        
        /* 文字渐变效果 */
        .text-gradient {
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        
        /* 渐变顶部栏 */
        .topbar-gradient {
            background: var(--gradient-topbar);
        }
        
        /* 数据卡片渐变背景 */
        .metric-card-gradient {
            background: var(--gradient-card);
            transition: all 0.3s ease;
        }
        
        .metric-card-gradient:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
    </style>
</head>
<body class="pb-24">

    <!-- Main Dashboard -->
    <main id="dashboard-view" class="pt-4 px-4 space-y-5 pb-24">

        <!-- Date & T+1 Badge -->
        <div class="flex items-center justify-between bg-white px-3 py-2 rounded-lg border border-gray-300 shadow-sm">
            <div class="flex items-center space-x-2">
                <i class="fa-regular fa-calendar text-primary text-xs"></i>
                <span class="text-xs text-text-tertiary">数据日期：</span>
                <span class="text-xs text-text-primary font-medium">2026-01-13 (昨日)</span>
            </div>
            <span class="text-[10px] text-text-tertiary bg-bg-container px-2 py-0.5 rounded">T+1 数据</span>
        </div>

        <!-- Metrics Cards (Horizontal Scroll) -->
        <div id="metrics-scroll-container" class="flex overflow-x-auto whitespace-nowrap pb-2 -mx-4 px-4 space-x-3 scrollbar-hide">
            <!-- Dynamic Content -->
        </div>

        <!-- Intelligence Tab Panel -->
        <section class="flex flex-col relative min-h-[500px]">
            <!-- Sticky Headers -->
            <div class="sticky-tabs flex mb-4 pt-2">
                <button onclick="switchHomeTab('supervision')" id="tab-home-supervision" class="flex-1 py-3 text-center text-xs font-bold text-primary border-b-2 border-primary transition-all">
                    任务
                </button>
                <button onclick="switchHomeTab('insights')" id="tab-home-insights" class="flex-1 py-3 text-center text-xs font-bold text-text-tertiary border-b-2 border-transparent hover:text-text-primary transition-all">
                    洞察
                </button>
                <button onclick="switchHomeTab('cases')" id="tab-home-cases" class="flex-1 py-3 text-center text-xs font-bold text-text-tertiary border-b-2 border-transparent hover:text-text-primary transition-all">
                    案例
                </button>
            </div>

            <!-- Tab Content -->
            
            <!-- 1. Supervision Tasks -->
            <div id="panel-home-supervision" class="animate-fade-in">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] text-text-tertiary">当前任务 (3/3)</span>
                    <button onclick="openCreateTaskView()" class="text-[10px] text-primary border border-primary/30 px-2 py-1 rounded hover:bg-primary-1 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> 新增任务
                    </button>
                </div>
                <div id="supervision-task-list" class="space-y-3">
                    <!-- Tasks Rendered by JS -->
                </div>
            </div>

            <!-- 2. Insights -->
            <div id="panel-home-insights" class="hidden animate-fade-in">
                
                <!-- Sub-tabs for Insights -->
                <div class="flex space-x-2 mb-4 bg-bg-container p-1 rounded-lg">
                    <button onclick="switchInsightsSubTab('keywords')" id="tab-insights-keywords" class="flex-1 py-2 text-center text-xs font-medium text-primary bg-primary-1 border border-primary/30 rounded-md transition-all">
                        热词
                    </button>
                    <button onclick="switchInsightsSubTab('sentiment')" id="tab-insights-sentiment" class="flex-1 py-2 text-center text-xs font-medium text-text-tertiary bg-transparent rounded-md transition-all hover:bg-bg-hover">
                        舆情
                    </button>
                </div>

                <!-- Keywords Section -->
                <div id="insights-keywords" class="space-y-3">
                    <!-- Dynamic List -->
                </div>

                <!-- Sentiment Section -->
                <div id="insights-sentiment" class="hidden">
                    <!-- Filter Tags - Horizontal Scroll -->
                    <div class="mb-4">
                        <div class="flex overflow-x-auto whitespace-nowrap pb-2 -mx-4 px-4 gap-2 scrollbar-hide bg-bg-container py-2 rounded-lg">
                            <button onclick="filterSentiments('all')" id="filter-all" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-primary-1 text-primary border border-primary/30 transition-all">
                                全部
                            </button>
                            <button onclick="filterSentiments('complaint')" id="filter-complaint" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-error/30 hover:text-error transition-all">
                                投诉
                            </button>
                            <button onclick="filterSentiments('dispute')" id="filter-dispute" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-error/30 hover:text-error transition-all">
                                纠纷
                            </button>
                            <button onclick="filterSentiments('stock-out')" id="filter-stock-out" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-warning/30 hover:text-warning-text transition-all">
                                商品缺货
                            </button>
                            <button onclick="filterSentiments('quality-issue')" id="filter-quality-issue" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-error/30 hover:text-error transition-all">
                                质量问题
                            </button>
                            <button onclick="filterSentiments('price-dispute')" id="filter-price-dispute" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-warning/30 hover:text-warning-text transition-all">
                                价格争议
                            </button>
                            <button onclick="filterSentiments('service-risk')" id="filter-service-risk" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-error/30 hover:text-error transition-all">
                                服务风险
                            </button>
                            <button onclick="filterSentiments('store-anomaly')" id="filter-store-anomaly" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-warning/30 hover:text-warning-text transition-all">
                                门店异常
                            </button>
                            <button onclick="filterSentiments('praise')" id="filter-praise" class="flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base hover:border-success/30 hover:text-success transition-all">
                                好评
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sentiment Cards List -->
                    <div id="sentiment-cards-container" class="space-y-3">
                        <!-- Dynamic Sentiment Cards -->
                    </div>
                </div>
            </div>

            <!-- 3. Excellent Cases -->
            <div id="panel-home-cases" class="hidden animate-fade-in">
                <div class="text-[10px] text-text-tertiary mb-3 text-center">昨日优秀话术精选</div>
                <div id="cases-list" class="space-y-4">
                    <!-- Dynamic Cases -->
                </div>
            </div>

        </section>
    </main>

    <!-- Profile View -->
    <main id="profile-view" class="hidden pt-4 px-4 space-y-5 pb-24">
        
        <!-- User Profile Card -->
        <div class="glass-panel rounded-xl p-5 relative overflow-hidden">
            <!-- Decorative Background -->
            <div class="absolute top-0 right-0 w-20 h-20 bg-primary-1 rounded-full -mr-10 -mt-10"></div>
            
            <div class="relative z-10 flex items-center space-x-4">
                <!-- Avatar -->
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-secondary-purple p-0.5">
                    <div class="w-full h-full rounded-full bg-white flex items-center justify-center">
                        <i class="fa-solid fa-user text-2xl text-primary"></i>
                    </div>
                </div>
                
                <!-- User Info -->
                <div class="flex-1">
                    <h2 class="text-lg font-bold text-text-primary mb-1">张总</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-[10px] bg-primary-1 text-primary px-2 py-0.5 rounded-full border border-primary/30">运营管理者</span>
                        <span class="text-xs text-text-tertiary">大参林连锁药店</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-2 gap-3">
            <div class="glass-panel rounded-xl p-3 text-center">
                <div class="text-xs text-text-tertiary mb-1">门店数</div>
                <div class="text-xl font-bold text-text-primary font-mono">18</div>
            </div>
            <div class="glass-panel rounded-xl p-3 text-center">
                <div class="text-xs text-text-tertiary mb-1">设备数</div>
                <div class="text-xl font-bold text-text-primary font-mono">120</div>
            </div>
        </div>

        <!-- Menu List -->
        <div class="space-y-3">
            <!-- Removed: Enterprise Info, System Settings, About System -->
        </div>

        <!-- Logout Button -->
        <button onclick="handleLogout()" class="w-full glass-panel rounded-xl p-4 border border-error/30 flex items-center justify-center space-x-2 active:scale-95 transition-transform mt-8 hover:bg-error-bg">
            <i class="fa-solid fa-right-from-bracket text-error"></i>
            <span class="text-sm text-error font-medium">退出登录</span>
        </button>

        <!-- Version Info -->
        <div class="text-center text-[10px] text-text-disabled pt-4 pb-2">
            药店智能决策系统 v1.2.0
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full h-16 bg-white/95 backdrop-blur border-t border-border-light flex z-50 shadow-hover">
        <button onclick="switchMainTab('dashboard')" id="nav-item-dashboard" class="flex-1 flex flex-col items-center justify-center space-y-1 text-primary">
            <i class="fa-solid fa-house text-lg"></i>
            <span class="text-[10px] font-medium">驾驶舱</span>
        </button>
        <button onclick="switchMainTab('profile')" id="nav-item-profile" class="flex-1 flex flex-col items-center justify-center space-y-1 text-text-tertiary hover:text-text-primary transition-colors">
            <i class="fa-solid fa-user-gear text-lg"></i>
            <span class="text-[10px]">我的</span>
        </button>
    </nav>

    <!-- Create Task View (Slide-in Page) -->
    <div id="create-task-view" class="fixed inset-0 bg-bg-light z-[60] transform translate-x-full transition-transform duration-300 flex flex-col">
        <header class="h-14 border-b border-border-light flex items-center justify-between px-4 bg-white">
            <button onclick="hideCreateTaskView()" class="w-8 h-8 flex items-center justify-center text-text-tertiary hover:text-text-primary">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 id="create-task-title" class="text-sm font-bold text-text-primary">新建任务</h1>
            <div class="w-8"></div>
        </header>
        
        <div class="flex-1 p-5 overflow-y-auto" id="create-task-body">
            <div class="space-y-6">
                
                <!-- AI Description Input -->
                <div id="ai-input-section" class="relative">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs text-primary font-bold">请输入监控需求</label>
                        <div class="flex items-center space-x-2">
                            <span id="ai-input-count" class="text-[10px] text-text-tertiary"><span class="text-primary">0</span>/200</span>
                            <button id="btn-clear-input" onclick="clearInput()" class="text-[10px] text-text-tertiary hover:text-error transition-colors hidden">
                                <i class="fa-solid fa-xmark mr-1"></i>清空
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="ai-input-desc" rows="4" maxlength="200" oninput="updateInputCharCount()" placeholder="例如：我想抓一下有没有推荐新品益生菌..." class="w-full bg-white border border-border-base rounded-lg px-4 py-3 pr-12 text-sm text-text-primary placeholder-text-disabled focus:outline-none focus:border-primary transition-colors resize-none"></textarea>
                        <button id="btn-voice-input" onclick="startVoiceInput()" class="absolute right-3 bottom-3 w-8 h-8 flex items-center justify-center bg-primary-1 text-primary rounded-full hover:bg-primary-2 transition-colors border border-primary/20">
                            <i class="fa-solid fa-microphone text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Voice Input Warning (Hidden by default) -->
                    <div id="voice-warning" class="hidden mt-2 bg-warning-bg p-3 rounded-lg border border-warning-border animate-fade-in">
                        <div class="flex items-start space-x-2">
                            <i class="fa-solid fa-exclamation-triangle text-warning-text mt-0.5"></i>
                            <div class="text-xs text-warning-text">语音输入已达上限（200字），已自动截断。您可以编辑或重新输入。</div>
                        </div>
                    </div>
                    
                    <!-- Quick Cases -->
                    <div class="mt-3">
                        <div class="text-[10px] text-text-tertiary mb-2">推荐案例：</div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="fillInput('查一下谁卖感冒药没推维C')" class="text-[10px] bg-white text-text-secondary px-3 py-1.5 rounded-full border border-border-base hover:border-primary hover:text-primary transition-colors">关联维C</button>
                            <button onclick="fillInput('检查是否说了欢迎光临')" class="text-[10px] bg-white text-text-secondary px-3 py-1.5 rounded-full border border-border-base hover:border-primary hover:text-primary transition-colors">欢迎语合规</button>
                            <button onclick="fillInput('有没有向会员介绍积分抵扣')" class="text-[10px] bg-white text-text-secondary px-3 py-1.5 rounded-full border border-border-base hover:border-primary hover:text-primary transition-colors">会员权益</button>
                        </div>
                    </div>
                </div>

                <!-- Generated Result (Hidden initially) -->
                <div id="generated-result-area" class="hidden space-y-5 animate-fade-in border-t border-border-light pt-5">
                    
                    <!-- Field 1: Name -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs text-text-secondary">任务名称</label>
                            <div class="flex items-center space-x-2">
                                <span id="task-name-count" class="text-[10px] text-text-tertiary"><span class="text-primary">0</span>/20</span>
                                <button onclick="regenerateField('task-name')" class="text-[10px] text-primary hover:text-primary-hover"><i class="fa-solid fa-rotate-right mr-1"></i>重写</button>
                            </div>
                        </div>
                        <input type="text" id="task-name" value="" maxlength="20" oninput="updateCharCount('task-name', 20)" class="w-full bg-white border border-border-base rounded-lg px-4 py-3 text-sm text-text-primary focus:outline-none focus:border-primary transition-colors">
                    </div>

                    <!-- Field 2: Intro -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs text-text-secondary">任务要求</label>
                            <div class="flex items-center space-x-2">
                                <span id="task-intro-count" class="text-[10px] text-text-tertiary"><span class="text-primary">0</span>/100</span>
                                <button onclick="regenerateField('task-intro')" class="text-[10px] text-primary hover:text-primary-hover"><i class="fa-solid fa-rotate-right mr-1"></i>重写</button>
                            </div>
                        </div>
                        <textarea id="task-intro" rows="2" maxlength="100" oninput="updateCharCount('task-intro', 100)" class="w-full bg-white border border-border-base rounded-lg px-4 py-3 text-sm text-text-primary focus:outline-none focus:border-primary transition-colors resize-none"></textarea>
                    </div>

                    <!-- Field 3: Action Plan -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs text-text-secondary">任务案例</label>
                            <div class="flex items-center space-x-2">
                                <span id="task-action-count" class="text-[10px] text-text-tertiary"><span class="text-primary">0</span>/200</span>
                                <button onclick="regenerateField('task-action')" class="text-[10px] text-primary hover:text-primary-hover"><i class="fa-solid fa-rotate-right mr-1"></i>重写</button>
                            </div>
                        </div>
                        <textarea id="task-action" rows="3" maxlength="200" oninput="updateCharCount('task-action', 200)" class="w-full bg-white border border-border-base rounded-lg px-4 py-3 text-sm text-text-primary focus:outline-none focus:border-primary transition-colors resize-none"></textarea>
                    </div>

                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="p-4 border-t border-border-light bg-white">
            <!-- State 1: Generate -->
            <button id="btn-initial-generate" onclick="triggerGenerate()" class="w-full btn-gradient-primary font-bold py-3 rounded-lg active:scale-95 flex items-center justify-center">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> 生成
            </button>

            <!-- State 2: Save & Regenerate (Hidden) -->
            <div id="btn-group-generated" class="hidden flex space-x-3">
                <button onclick="resetGenerate()" class="flex-1 bg-white text-text-secondary font-bold py-3 rounded-lg border border-border-base hover:bg-bg-hover active:scale-95 transition-transform">
                    <i class="fa-solid fa-rotate mr-1"></i> 重新生成
                </button>
                <button id="btn-save-task" onclick="saveNewTask()" class="flex-[2] btn-gradient-primary font-bold py-3 rounded-lg active:scale-95">
                    <i class="fa-solid fa-check mr-1"></i> 保存指标
                </button>
            </div>
        </div>
    </div>

    <!-- Metric Detail View (Slide-in Page) -->
    <div id="metric-detail-view" class="fixed inset-0 bg-bg-light z-[65] transform translate-x-full transition-transform duration-300 flex flex-col">
        <header class="h-14 border-b border-border-light flex items-center justify-between px-4 bg-white">
            <button onclick="hideMetricDetailView()" class="w-8 h-8 flex items-center justify-center text-text-tertiary hover:text-text-primary">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-sm font-bold text-text-primary">指标详情</h1>
            <div class="w-8"></div>
        </header>

        <div class="flex-1 overflow-y-auto pb-6">
            <!-- Header Card -->
            <div class="p-4 topbar-gradient border-b border-border-light">
                <div class="text-center mb-4">
                    <h2 id="metric-detail-title" class="text-2xl font-bold text-text-primary mb-3">...</h2>
                    <div id="metric-detail-value" class="text-4xl font-bold text-gradient font-mono mb-3">...</div>
                    <div id="metric-detail-change" class="flex items-center justify-center text-sm">
                        <!-- Dynamic content -->
                    </div>
                </div>
                
                <!-- Warning for Traffic Metric -->
                <div id="metric-warning" class="hidden mt-4 bg-warning-bg p-3 rounded-lg border border-warning-border">
                    <div class="flex items-start space-x-2">
                        <i class="fa-solid fa-lightbulb text-warning-text mt-0.5"></i>
                        <div class="text-xs text-warning-text">客流量数据通过语音数据获取，存在一定误差</div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="p-4 border-b border-border-light bg-white">
                <div class="flex items-center justify-between mb-3">
                    <h3 id="metric-chart-title" class="text-xs font-bold text-text-primary border-l-2 border-primary pl-2">近7日趋势</h3>
                </div>
                
                <!-- Trend Switch Buttons (Only for Traffic Metric) -->
                <div id="trend-switch-container" class="hidden flex space-x-2 mb-4 bg-bg-container p-1 rounded-lg">
                    <button onclick="switchMetricTrend('7days')" id="btn-trend-7days" class="flex-1 py-2 text-center text-xs font-medium text-primary bg-primary-1 border border-primary/30 rounded-md transition-all">
                        7日趋势
                    </button>
                    <button onclick="switchMetricTrend('hourly')" id="btn-trend-hourly" class="flex-1 py-2 text-center text-xs font-medium text-text-tertiary bg-transparent rounded-md hover:bg-bg-hover transition-all">
                        昨日分时趋势
                    </button>
                </div>
                
                <div class="chart-container" style="height: 200px;">
                    <canvas id="metric-detail-chart"></canvas>
                </div>
            </div>

            <!-- Store Ranking -->
            <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-bold text-text-primary border-l-2 border-primary pl-2">门店排行榜</h3>
                    <span class="text-[10px] text-text-tertiary">昨日数据</span>
                </div>
                <div id="metric-store-list" class="space-y-2">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail View (Slide-in Page) -->
    <div id="task-detail-view" class="fixed inset-0 bg-bg-light z-[65] transform translate-x-full transition-transform duration-300 flex flex-col">
        <header class="h-14 border-b border-border-light flex items-center justify-between px-4 bg-white">
            <button onclick="hideTaskDetailView()" class="w-8 h-8 flex items-center justify-center text-text-tertiary hover:text-text-primary">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-sm font-bold text-text-primary">任务详情</h1>
            <div class="w-8"></div>
        </header>

        <div class="flex-1 overflow-y-auto pb-6">
            <!-- Header Card -->
            <div class="p-4 bg-gradient-to-b from-primary-1 to-bg-light border-b border-border-light">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h2 id="detail-task-title" class="text-lg font-bold text-text-primary mb-1">...</h2>
                    </div>
                    <div class="text-right flex flex-col items-end">
                         <button onclick="openTaskShareModal(currentDetailTaskId)" class="mb-2 text-primary bg-primary-1 w-8 h-8 rounded-full flex items-center justify-center hover:bg-primary-2 transition-colors border border-primary/20">
                                <i class="fa-solid fa-share-nodes text-xs"></i>
                         </button>
                         <div class="text-[10px] text-text-tertiary mb-0.5">昨日执行率</div>
                         <div id="detail-task-value" class="text-2xl font-bold text-primary font-mono">--%</div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-white p-3 rounded-lg border border-border-base shadow-sm">
                        <div class="text-[10px] text-text-tertiary mb-1">任务要求</div>
                        <div id="detail-task-intro" class="text-xs text-text-secondary leading-relaxed">...</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-border-base shadow-sm">
                        <div class="text-[10px] text-text-tertiary mb-1">任务案例 (SOP)</div>
                        <div id="detail-task-action" class="text-xs text-text-secondary leading-relaxed">...</div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="p-4 border-b border-border-light bg-white">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-bold text-text-primary border-l-2 border-primary pl-2">近7日趋势</h3>
                </div>
                <div class="chart-container" style="height: 200px;">
                    <canvas id="detail-task-chart"></canvas>
                </div>
            </div>

            <!-- Store Ranking -->
            <div class="p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-bold text-text-primary border-l-2 border-primary pl-2">门店执行红黑榜</h3>
                    <span class="text-[10px] text-text-tertiary">昨日数据</span>
                </div>
                <div id="detail-store-list" class="space-y-2">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Case Detail View (Slide-in Page) -->
    <div id="case-detail-view" class="fixed inset-0 bg-bg-light z-[65] transform translate-x-full transition-transform duration-300 flex flex-col">
        <header class="h-14 border-b border-border-light flex items-center justify-between px-4 bg-white">
            <button onclick="hideCaseDetailView()" class="w-8 h-8 flex items-center justify-center text-text-tertiary hover:text-text-primary">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-sm font-bold text-text-primary">案例详情</h1>
            <div class="w-8"></div>
        </header>

        <div class="flex-1 overflow-y-auto pb-24">
            <!-- Hero Card (Staff) -->
            <div class="p-5 bg-gradient-to-b from-primary-1 to-bg-light">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-white border-2 border-primary p-0.5 shadow-sm">
                            <img src="" id="case-detail-avatar" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <h2 id="case-detail-name" class="text-lg font-bold text-text-primary">...</h2>
                                <span id="case-detail-store" class="text-[10px] text-text-tertiary bg-white px-2 py-0.5 rounded-full border border-border-light">...</span>
                            </div>
                            <div id="case-detail-tag" class="text-xs text-primary mt-1">...</div>
                        </div>
                    </div>
                </div>

                <!-- AI Insight -->
                <div class="bg-white p-4 rounded-xl border border-primary/20 relative overflow-hidden mb-4 shadow-card">
                    <div class="absolute top-0 left-0 w-1 h-full bg-primary"></div>
                    <div class="flex items-start space-x-3">
                        <i class="fa-solid fa-wand-magic-sparkles text-primary mt-1"></i>
                        <div>
                            <div class="text-xs font-bold text-text-primary mb-1">AI 亮点点评</div>
                            <p id="case-detail-reason" class="text-xs text-text-secondary leading-relaxed">...</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Transcript -->
            <div class="px-4 bg-white pt-4">
                <div class="text-xs font-bold text-text-tertiary mb-3 ml-1">对话记录</div>
                <div id="case-transcript-list" class="space-y-4">
                    <!-- Chat Bubbles -->
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="fixed bottom-0 w-full p-4 bg-white/95 backdrop-blur border-t border-border-light flex z-[70] shadow-hover">
             <button onclick="openCaseShareModal()" class="w-full btn-gradient-primary font-bold py-3 rounded-lg active:scale-95 flex items-center justify-center">
                <i class="fa-solid fa-share-nodes mr-2"></i> 分享优秀案例
            </button>
        </div>
    </div>

    <!-- Share Task Modal (Floating Window) -->
    <div id="share-task-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh] shadow-modal">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-border-light">
                <h3 class="text-sm font-bold text-text-primary">任务分享预览</h3>
                <button onclick="closeTaskShareModal()" class="text-text-tertiary hover:text-text-primary">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Poster Preview Area -->
            <div class="p-4 overflow-y-auto flex-1 bg-bg-light">
                <div id="task-poster-node" class="bg-gradient-to-br from-primary-1 to-white border border-border-base rounded-xl p-5 shadow-card relative overflow-hidden">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-20 h-20 bg-primary-2 rounded-full -mr-10 -mt-10"></div>
                    <div class="absolute bottom-0 left-0 w-20 h-20 bg-secondary-purple/10 rounded-full -ml-10 -mb-10"></div>
                    
                    <!-- Content -->
                    <div class="relative z-10 text-center space-y-4">
                        <div class="inline-block px-3 py-1 rounded-full border border-primary/30 text-primary text-[10px] bg-primary-1 mb-2">
                            <i class="fa-solid fa-bullseye mr-1"></i> 重点任务
                        </div>
                        <h2 id="poster-task-title" class="text-xl font-bold text-text-primary leading-tight">...</h2>
                        
                        <div class="w-full h-px bg-gradient-to-r from-transparent via-border-base to-transparent my-4"></div>
                        
                        <div class="text-left bg-white rounded-lg p-3 border border-border-light shadow-sm">
                            <div class="text-[10px] text-text-tertiary mb-1">执行方案 (SOP)</div>
                            <div id="poster-task-desc" class="text-sm text-text-primary leading-relaxed font-medium">...</div>
                        </div>

                        <div class="pt-4 flex justify-between items-end">
                             <div class="text-left">
                                 <div class="text-[10px] text-text-tertiary">发布时间</div>
                                 <div id="poster-create-time" class="text-xs text-text-secondary font-mono">...</div>
                             </div>
                             <div class="text-right">
                                 <div class="text-[10px] text-text-tertiary">药店智能决策系统</div>
                                 <div class="text-[10px] text-text-disabled">Smart Badge System</div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="p-4 border-t border-border-light bg-white grid grid-cols-2 gap-3">
                <button onclick="downloadPoster()" class="flex items-center justify-center space-x-2 bg-bg-container text-text-primary py-3 rounded-lg hover:bg-bg-hover transition-colors border border-border-base">
                    <i class="fa-solid fa-download"></i>
                    <span class="text-xs font-bold">保存图片</span>
                </button>
                <button onclick="shareToWeChat()" class="flex items-center justify-center space-x-2 bg-success text-white py-3 rounded-lg hover:opacity-90 transition-opacity">
                    <i class="fa-brands fa-weixin"></i>
                    <span class="text-xs font-bold">分享给店员</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Sentiment Detail View (Slide-in Page) -->
    <div id="sentiment-detail-view" class="fixed inset-0 bg-bg-light z-[65] transform translate-x-full transition-transform duration-300 flex flex-col">
        <header class="h-14 border-b border-border-light flex items-center justify-between px-4 bg-white">
            <button onclick="hideSentimentDetailView()" class="w-8 h-8 flex items-center justify-center text-text-tertiary hover:text-text-primary">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-sm font-bold text-text-primary">舆情详情</h1>
            <div class="w-8"></div>
        </header>

        <div class="flex-1 overflow-y-auto pb-24">
            <!-- Header Card -->
            <div class="p-5 bg-gradient-to-b from-error-bg to-bg-light border-b border-border-light">
                <!-- Type & Priority -->
                <div class="flex items-center space-x-2 mb-3">
                    <span id="sentiment-type-tag" class="text-xs font-bold px-3 py-1 rounded-full">...</span>
                    <span id="sentiment-priority" class="text-sm">...</span>
                </div>

                <!-- Title -->
                <h2 id="sentiment-title" class="text-lg font-bold text-text-primary mb-3">...</h2>

                <!-- Meta Info -->
                <div class="flex items-center justify-between text-xs text-text-tertiary mb-4">
                    <div class="flex items-center space-x-4">
                        <span><i class="fa-regular fa-clock mr-1"></i><span id="sentiment-time">...</span></span>
                        <span><i class="fa-solid fa-store mr-1"></i><span id="sentiment-store">...</span></span>
                    </div>
                </div>

                <!-- Staff Info -->
                <div class="flex items-center space-x-3 bg-white p-3 rounded-lg border border-border-base shadow-sm">
                    <div class="w-10 h-10 rounded-full bg-bg-container border border-border-base overflow-hidden">
                        <img src="" id="sentiment-staff-avatar" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <div class="text-sm font-medium text-text-primary" id="sentiment-staff-name">...</div>
                        <div class="text-[10px] text-text-tertiary">当事员工</div>
                    </div>
                </div>
            </div>

            <!-- Event Summary -->
            <div class="p-4 border-b border-border-light bg-white">
                <h3 class="text-xs font-bold text-text-primary border-l-2 border-primary pl-2 mb-3">事件详情</h3>
                <div class="bg-bg-light p-4 rounded-lg border border-border-light">
                    <div id="sentiment-summary" class="text-sm text-text-secondary leading-relaxed">...</div>
                </div>
            </div>

            <!-- Conversation Transcript -->
            <div class="p-4 bg-white">
                <h3 class="text-xs font-bold text-text-primary border-l-2 border-primary pl-2 mb-3">对话记录</h3>
                <div id="sentiment-transcript" class="space-y-3">
                    <!-- Transcript bubbles -->
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="fixed bottom-0 w-full p-4 bg-white/95 backdrop-blur border-t border-border-light z-[70] shadow-hover">
            <button onclick="openSentimentShareModal()" class="w-full btn-gradient-primary font-bold py-3 rounded-lg active:scale-95 flex items-center justify-center">
                <i class="fa-solid fa-share-nodes mr-2"></i> 分享
            </button>
        </div>
    </div>

    <!-- Share Sentiment Modal (New) -->
    <div id="share-sentiment-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh] shadow-modal">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-border-light">
                <h3 class="text-sm font-bold text-text-primary">舆情分享预览</h3>
                <button onclick="closeSentimentShareModal()" class="text-text-tertiary hover:text-text-primary">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Poster Preview Area -->
            <div class="p-4 overflow-y-auto flex-1 bg-bg-light">
                <div id="sentiment-poster-node" class="bg-gradient-to-br from-error-bg to-white border border-border-base rounded-xl p-5 shadow-card relative overflow-hidden">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-24 h-24 bg-error/10 rounded-full -mr-10 -mt-10"></div>
                    
                    <!-- Content -->
                    <div class="relative z-10 space-y-4">
                        <!-- Type Badge -->
                        <div class="flex items-center justify-between">
                            <div>
                                <span id="poster-sentiment-type" class="inline-block px-3 py-1 rounded-full text-xs font-bold">...</span>
                                <span id="poster-sentiment-priority" class="ml-2 text-base">...</span>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] text-text-tertiary">发生时间</div>
                                <div id="poster-sentiment-time" class="text-xs text-text-secondary font-mono">...</div>
                            </div>
                        </div>

                        <div class="w-full h-px bg-border-base my-2"></div>

                        <!-- Title -->
                        <h2 id="poster-sentiment-title" class="text-lg font-bold text-text-primary leading-tight">...</h2>
                        
                        <!-- Staff Info -->
                        <div class="flex items-center space-x-3 bg-white p-3 rounded-lg border border-border-base shadow-sm">
                            <div class="w-10 h-10 rounded-full bg-bg-container overflow-hidden border border-border-base">
                                <img src="" id="poster-sentiment-avatar" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div id="poster-sentiment-staff" class="text-sm font-medium text-text-primary">...</div>
                                <div id="poster-sentiment-store" class="text-[10px] text-text-tertiary">...</div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div class="bg-white p-3 rounded-lg border-l-2 border-error shadow-sm">
                            <div class="text-[10px] text-text-tertiary mb-1">事件摘要</div>
                            <div id="poster-sentiment-summary" class="text-xs text-text-secondary leading-relaxed line-clamp-4">...</div>
                        </div>

                        <!-- Key Transcript -->
                        <div class="bg-bg-light rounded-lg p-3 border border-border-light">
                            <div class="text-[10px] text-text-tertiary mb-2">关键对话片段</div>
                            <div id="poster-sentiment-transcript" class="space-y-2 text-xs text-text-secondary">
                                <!-- Selected transcript -->
                            </div>
                        </div>

                        <div class="pt-4 flex justify-between items-end">
                            <div class="text-left">
                                <div class="text-[10px] text-text-tertiary">药店智能决策系统</div>
                                <div class="text-[10px] text-text-disabled">Smart Badge System</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="p-4 border-t border-border-light bg-white grid grid-cols-2 gap-3">
                <button onclick="downloadPoster()" class="flex items-center justify-center space-x-2 bg-bg-container text-text-primary py-3 rounded-lg hover:bg-bg-hover transition-colors border border-border-base">
                    <i class="fa-solid fa-download"></i>
                    <span class="text-xs font-bold">保存图片</span>
                </button>
                <button onclick="shareToWeChat()" class="flex items-center justify-center space-x-2 bg-success text-white py-3 rounded-lg hover:opacity-90 transition-opacity">
                    <i class="fa-brands fa-weixin"></i>
                    <span class="text-xs font-bold">分享给店长</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Share Case Modal (New) -->
    <div id="share-case-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center p-6 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh] shadow-modal">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-border-light">
                <h3 class="text-sm font-bold text-text-primary">案例分享预览</h3>
                <button onclick="closeCaseShareModal()" class="text-text-tertiary hover:text-text-primary">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Poster Preview Area -->
            <div class="p-4 overflow-y-auto flex-1 bg-bg-light">
                <div id="case-poster-node" class="bg-gradient-to-br from-success-bg to-white border border-border-base rounded-xl p-5 shadow-card relative overflow-hidden">
                    <!-- Decorative Elements -->
                    <div class="absolute top-0 right-0 w-24 h-24 bg-success/10 rounded-full -mr-10 -mt-10"></div>
                    
                    <!-- Content -->
                    <div class="relative z-10 space-y-4">
                        <div class="flex items-center justify-between">
                             <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-bg-container overflow-hidden border border-border-base">
                                    <img src="" id="poster-case-avatar" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <div id="poster-case-name" class="text-sm font-bold text-text-primary">...</div>
                                    <div id="poster-case-store" class="text-[10px] text-text-tertiary">...</div>
                                </div>
                             </div>
                             <div class="text-right">
                                 <div class="text-[10px] text-text-tertiary">接待时长</div>
                                 <div id="poster-case-duration" class="text-sm font-bold text-text-primary font-mono">...</div>
                             </div>
                        </div>

                        <div class="w-full h-px bg-border-base my-2"></div>

                        <div class="inline-block px-3 py-1 rounded-full border border-success/30 text-success text-[10px] bg-success-bg mb-1">
                            <i class="fa-solid fa-thumbs-up mr-1"></i> 优秀案例
                        </div>
                        
                        <div class="bg-white p-3 rounded-lg border-l-2 border-success shadow-sm">
                            <div class="text-[10px] text-text-tertiary mb-1">AI 亮点点评</div>
                            <div id="poster-case-reason" class="text-sm text-text-primary leading-relaxed font-medium">...</div>
                        </div>

                        <div class="bg-bg-light rounded-lg p-3 flex flex-col border border-border-light">
                            <div class="text-[10px] text-text-tertiary mb-2">对话记录</div>
                             <div id="poster-case-transcript" class="space-y-2 text-xs text-text-secondary max-h-60 overflow-y-auto pr-1">
                                 <!-- Complete conversation transcript -->
                             </div>
                        </div>

                        <div class="pt-4 flex justify-between items-end">
                             <div class="text-left">
                                 <div class="text-[10px] text-text-tertiary">会话时间</div>
                                 <div id="poster-case-time" class="text-xs text-text-secondary font-mono">...</div>
                             </div>
                             <div class="text-right">
                                 <div class="text-[10px] text-text-tertiary">药店智能决策系统</div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="p-4 border-t border-border-light bg-white grid grid-cols-2 gap-3">
                <button onclick="downloadPoster()" class="flex items-center justify-center space-x-2 bg-bg-container text-text-primary py-3 rounded-lg hover:bg-bg-hover transition-colors border border-border-base">
                    <i class="fa-solid fa-download"></i>
                    <span class="text-xs font-bold">保存图片</span>
                </button>
                <button onclick="shareToWeChat()" class="flex items-center justify-center space-x-2 bg-success text-white py-3 rounded-lg hover:opacity-90 transition-opacity">
                    <i class="fa-brands fa-weixin"></i>
                    <span class="text-xs font-bold">分享到工作群</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- Mock Data ---
        const metricsData = [
            { title: '客流量', value: '1,250人', changeAbs: '+50人', changeRel: '+4.2%', isUp: true },
            { title: '工牌使用率', value: '85%', changeAbs: '+5%', changeRel: '+6.2%', isUp: true },
            { title: '平均时长', value: '7.2h', changeAbs: '-0.5h', changeRel: '-6.5%', isUp: false },
        ];

        const supervisionTasks = [
            { id: 1, title: '流感关联维C', desc: '买感冒药时推荐维生素C', value: '68%', changeRel: '+12%', isUp: true, createTime: '2026-01-10' },
            { id: 2, title: '会员日双倍积分', desc: '结账时提醒会员权益', value: '92%', changeRel: '+5%', isUp: true, createTime: '2026-01-11' },
            { id: 3, title: '新品益生菌', desc: '抗生素关联益生菌', value: '45%', changeRel: '-8%', isUp: false, createTime: '2026-01-12' },
        ];

        const hotWords = [
            { rank: 1, text: '感冒灵', type: '药品', count: 324, status: 'up' },
            { rank: 2, text: '布洛芬', type: '药品', count: 289, status: 'stable' },
            { rank: 3, text: '咳嗽', type: '症状', count: 210, status: 'down' },
            { rank: 4, text: '流感', type: '症状', count: 188, status: 'new' },
            { rank: 5, text: '会员日', type: '活动', count: 156, status: 'up' },
        ];

        const sentimentData = [
            {
                id: 's1',
                type: 'complaint',
                typeText: '投诉',
                priority: 'high',
                priorityIcon: '🔥',
                title: '顾客投诉店员态度冷漠',
                time: '2026-01-13 14:35',
                store: '中心广场店',
                staff: {
                    name: '张晓敏',
                    avatar: 'https://i.pravatar.cc/150?u=staff1'
                },
                summary: '顾客咨询儿童感冒药用法用量时，店员张晓敏回答简短且语气不耐烦，顾客多次追问仍未获得满意答复。顾客情绪激动，表示要投诉到药监局。最终顾客未购买商品离店，并在门口与其他顾客抱怨此次经历，造成不良影响。',
                riskLevel: 'high',
                transcript: [
                    { role: 'user', text: '你好，我想问一下这个小儿感冒药，三岁孩子怎么吃？', time: '14:35:10' },
                    { role: 'staff', text: '说明书上写着呢。', time: '14:35:15', highlight: true, note: '回答敷衍' },
                    { role: 'user', text: '我知道说明书，但是我想问得详细一点，比如饭前还是饭后...', time: '14:35:22' },
                    { role: 'staff', text: '都行。', time: '14:35:26', highlight: true, note: '态度冷淡' },
                    { role: 'user', text: '你这什么态度啊！我要投诉你！', time: '14:35:35', highlight: true, note: '顾客情绪激动' }
                ],
                actionSuggest: '建议店长立即致电顾客致歉，说明员工状态不佳的原因，并提供50元代金券作为补偿。同时对张晓敏进行谈话提醒。',
                trainingSuggest: '该员工需加强服务意识培训，特别是顾客咨询场景下的耐心沟通技巧。建议安排"儿童用药常见问题应答"专项培训。'
            },
            {
                id: 's2',
                type: 'dispute',
                typeText: '纠纷',
                priority: 'high',
                priorityIcon: '💥',
                title: '顾客与店员发生激烈争吵',
                time: '2026-01-13 11:20',
                store: '万达广场店',
                staff: {
                    name: '赵敏',
                    avatar: 'https://i.pravatar.cc/150?u=staff5'
                },
                summary: '顾客认为购买的钙片无效要求退货，店员赵敏告知已开封不能退。顾客情绪激动，指责店员欺骗消费者。双方发生激烈争吵，引发多名顾客围观。最终店长介入，同意换货并赔礼道歉才平息事态。',
                riskLevel: 'high',
                transcript: [
                    { role: 'user', text: '我买的这个钙片吃了半个月，一点用都没有，你们给我退了！', time: '11:20:05' },
                    { role: 'staff', text: '您好，这个已经开封了，按规定不能退货的。', time: '11:20:12' },
                    { role: 'user', text: '什么规定？你们当时就说有效，现在没效你们就不管了是吧？', time: '11:20:20', highlight: true, note: '顾客情绪激动' },
                    { role: 'staff', text: '大姐您别激动，保健品需要长期服用才有效果...', time: '11:20:28' },
                    { role: 'user', text: '你说谁大姐呢？我看你们就是骗人的黑店！', time: '11:20:35', highlight: true, note: '冲突升级' }
                ],
                actionSuggest: '立即向顾客致歉，说明退换货政策，必要时破例处理以平息纠纷。对店员进行冲突处理技巧培训，强调遇到情绪激动顾客时应立即请店长介入。',
                trainingSuggest: '全员培训"顾客投诉与纠纷处理规范"，学习降级技巧，避免语言冲突。建议设置"顾客权益保障专员"角色。'
            },
            {
                id: 's3',
                type: 'stock-out',
                typeText: '商品缺货',
                priority: 'medium',
                priorityIcon: '📦',
                title: '连花清瘟缺货导致顾客流失',
                time: '2026-01-13 09:15',
                store: '火车站店',
                staff: {
                    name: '李娟',
                    avatar: 'https://i.pravatar.cc/150?u=staff6'
                },
                summary: '流感高发期，顾客点名要买连花清瘟胶囊，但门店已断货3天。店员推荐替代品被顾客拒绝，顾客表示"那我去隔壁买"后离店。当天该门店记录到8次类似缺货情况，造成销售机会损失。',
                riskLevel: 'medium',
                transcript: [
                    { role: 'user', text: '有连花清瘟吗？', time: '09:15:05' },
                    { role: 'staff', text: '不好意思，这个暂时没货了。您看要不试试感冒灵？效果也很好。', time: '09:15:12', highlight: true, note: '推荐替代品' },
                    { role: 'user', text: '不要，我就要连花清瘟。那我去隔壁看看吧。', time: '09:15:20', highlight: true, note: '顾客流失' }
                ],
                actionSuggest: '立即联系供应商补货，并在门店入口处张贴"连花清瘟补货中"告示。统计近期热销药品缺货频次，优化库存预警机制。',
                trainingSuggest: '培训店员在缺货场景下的应对话术，学习如何有效推荐替代品，提升转化率。'
            },
            {
                id: 's4',
                type: 'quality-issue',
                typeText: '质量问题',
                priority: 'high',
                priorityIcon: '⚠️',
                title: '顾客反映药品包装破损',
                time: '2026-01-13 13:40',
                store: '南门店',
                staff: {
                    name: '周杰',
                    avatar: 'https://i.pravatar.cc/150?u=staff7'
                },
                summary: '顾客购买某品牌维生素后发现包装盒有破损，瓶盖松动。店员周杰立即为顾客更换新品并致歉。经核查，该批次商品在运输过程中受损，门店已将剩余库存下架，并向供应商反馈质量问题。',
                riskLevel: 'high',
                transcript: [
                    { role: 'user', text: '你好，我刚买的这个维生素，包装盒都破了，瓶盖也松的。', time: '13:40:05', highlight: true, note: '质量问题' },
                    { role: 'staff', text: '真的很抱歉！我马上给您换一瓶新的，您稍等。', time: '13:40:12' },
                    { role: 'staff', text: '给您换好了，这瓶是完好的。给您带来不便真的很抱歉。', time: '13:40:35' },
                    { role: 'user', text: '好的，谢谢。', time: '13:40:40' }
                ],
                actionSuggest: '立即对该批次商品进行全面检查，问题商品下架处理。联系供应商核实质量问题原因，必要时启动退货流程。',
                trainingSuggest: '加强收货验收环节培训，要求员工对每批新货进行外观检查，发现包装破损及时记录并隔离。'
            },
            {
                id: 's5',
                type: 'price-dispute',
                typeText: '价格争议',
                priority: 'medium',
                priorityIcon: '💰',
                title: '顾客质疑价格比网上贵',
                time: '2026-01-13 15:50',
                store: '解放路店',
                staff: {
                    name: '孙丽',
                    avatar: 'https://i.pravatar.cc/150?u=staff8'
                },
                summary: '顾客购买某保健品时用手机查询发现网购价格便宜30元，质疑门店价格虚高。店员孙丽解释实体店有房租、人工等成本，并强调可以提供专业用药咨询服务。顾客表示理解但仍未购买。',
                riskLevel: 'low',
                transcript: [
                    { role: 'user', text: '这个蛋白粉多少钱？', time: '15:50:05' },
                    { role: 'staff', text: '268元。', time: '15:50:08' },
                    { role: 'user', text: '我看网上才238，你们这怎么贵这么多？', time: '15:50:15', highlight: true, note: '价格质疑' },
                    { role: 'staff', text: '网上是便宜一点，但我们实体店可以现场为您讲解服用方法，有问题随时来咨询。', time: '15:50:25' },
                    { role: 'user', text: '那我还是网上买吧，便宜点。', time: '15:50:35' }
                ],
                actionSuggest: '分析该商品定价策略，评估是否需要调整。可推出"线上价格匹配"或"会员专享价"等促销活动，提升竞争力。',
                trainingSuggest: '培训店员应对价格质疑的话术，强调实体店的增值服务（专业咨询、快速取药、售后保障）。'
            },
            {
                id: 's6',
                type: 'service-risk',
                typeText: '服务风险',
                priority: 'high',
                priorityIcon: '🚨',
                title: '店员推荐药品时未询问过敏史',
                time: '2026-01-13 16:20',
                store: '滨江路分店',
                staff: {
                    name: '李强',
                    avatar: 'https://i.pravatar.cc/150?u=staff2'
                },
                summary: '顾客购买头孢类抗生素时，店员李强直接推荐并收银，全程未询问顾客是否有青霉素过敏史。虽然顾客本次未发生不良反应，但此操作违反《药品经营质量管理规范》，存在重大用药安全隐患。',
                riskLevel: 'high',
                transcript: [
                    { role: 'user', text: '给我拿盒头孢。', time: '16:20:05' },
                    { role: 'staff', text: '这个效果好，89块。', time: '16:20:10', highlight: true, note: '未询问过敏史' },
                    { role: 'user', text: '行，微信付。', time: '16:20:15' }
                ],
                actionSuggest: '立即通知该店长加强合规培训，要求所有员工在销售处方药或抗生素时，必须询问过敏史并登记。建议对该员工进行书面警告。',
                trainingSuggest: '全员进行"抗生素销售规范流程"复训，考核合格后方可上岗。重点强调过敏史询问环节的法律风险。'
            },
            {
                id: 's7',
                type: 'store-anomaly',
                typeText: '门店异常',
                priority: 'medium',
                priorityIcon: '🔧',
                title: '门店空调故障影响顾客体验',
                time: '2026-01-13 12:30',
                store: 'CBD店',
                staff: {
                    name: '陈涛',
                    avatar: 'https://i.pravatar.cc/150?u=staff9'
                },
                summary: '门店中央空调突然故障，室内温度升高，多名顾客抱怨闷热。店员陈涛及时联系物业维修，并为等待的顾客提供免费饮用水。维修耗时2小时，期间部分顾客提前离店。',
                riskLevel: 'medium',
                transcript: [
                    { role: 'user', text: '你们店里怎么这么热啊？', time: '12:30:05' },
                    { role: 'staff', text: '真的很抱歉，空调刚才突然坏了，我们已经在联系维修了。', time: '12:30:12' },
                    { role: 'staff', text: '您要不先喝点水？我给您倒。', time: '12:30:20', highlight: true, note: '贴心服务' },
                    { role: 'user', text: '算了，我先走了，太热了。', time: '12:30:28', highlight: true, note: '顾客流失' }
                ],
                actionSuggest: '加强设施设备定期维护，建立应急预案。遇到突发故障时，及时告知顾客并提供补偿措施（如临时降价、发放代金券）。',
                trainingSuggest: '培训店员应对突发设施故障的应急话术和服务补救措施，减少顾客流失。'
            },
            {
                id: 's8',
                type: 'praise',
                typeText: '好评',
                priority: 'low',
                priorityIcon: '👍',
                title: '顾客当面表扬店员服务细心',
                time: '2026-01-13 10:45',
                store: '体育馆店',
                staff: {
                    name: '王芳',
                    avatar: 'https://i.pravatar.cc/150?u=staff3'
                },
                summary: '顾客为老人购买降压药时，店员王芳主动询问老人是否有其他基础疾病，提醒药物禁忌，并详细讲解服用时间和注意事项。顾客非常满意，当场表示"你们这个小姑娘真专业，比医院的都讲得清楚"。',
                riskLevel: 'low',
                transcript: [
                    { role: 'user', text: '帮我买盒降压药。', time: '10:45:05' },
                    { role: 'staff', text: '好的，老人家有没有糖尿病或者肾脏方面的问题呢？', time: '10:45:12', highlight: true, note: '主动询问病史' },
                    { role: 'user', text: '没有，就是血压有点高。', time: '10:45:20' },
                    { role: 'staff', text: '那这个可以。每天早上一片，空腹吃效果最好。另外提醒一下，吃这个药期间不要吃西柚，会影响药效。', time: '10:45:28', highlight: true, note: '贴心提醒' },
                    { role: 'user', text: '你们这个小姑娘真专业，谢谢啊！', time: '10:45:40' }
                ],
                actionSuggest: '建议将王芳的服务案例作为培训素材，在全公司推广。可给予月度"金牌店员"称号或物质奖励。',
                trainingSuggest: '提取王芳的服务话术，制作成"老年人用药服务标准流程"，供其他员工学习。'
            }
        ];

        const casesData = [
            { 
                id: 'c1', 
                name: '李晓红', 
                store: '中心广场店', 
                tag: '教科书式挽留', 
                reason: '在顾客明确表示“嫌贵”拒绝后，店员没有降价，而是巧妙使用了“平摊成本法”（一天才几毛钱），成功打消顾客顾虑，完成高客单价转化。',
                duration: '5分12秒',
                startTime: '今日 10:30',
                transcript: [
                    { role: 'staff', text: '姐，这款胶原蛋白肽现在活动很划算，买三送一。', time: '10:30:15' },
                    { role: 'user', text: '哎哟，太贵了，三百多块钱呢，不买了。', time: '10:30:22' },
                    { role: 'staff', text: '姐，乍一听是挺贵。但您算笔账，一套能吃两个月。', highlight: true, note: '拆解成本', time: '10:30:28' },
                    { role: 'staff', text: '平摊下来每天不到5块钱，也就一杯奶茶钱。奶茶喝了长胖，这个喝了能让皮肤变亮，多值呀！', highlight: true, note: '价值锚定', time: '10:30:45' },
                    { role: 'user', text: '呵呵，你这小姑娘真会说话。那行吧，来一套。', time: '10:31:05' }
                ]
            },
            { 
                id: 'c2', 
                name: '王强', 
                store: '滨江路分店', 
                tag: '高情商回复', 
                reason: '面对顾客对药效的质疑，没有直接反驳，而是通过“共情+专业背书”的方式建立信任，体现了极高的服务水准。',
                duration: '3分45秒',
                startTime: '今日 14:15',
                transcript: [
                    { role: 'user', text: '你们这药是不是假的啊？吃了两天没一点用。', time: '14:15:10' },
                    { role: 'staff', text: '大哥您别急，我特别理解您的心情，生病了谁都想马上好。', highlight: true, note: '先共情', time: '14:15:18' },
                    { role: 'staff', text: '不过中成药起效确实温和些。您看说明书这里写了，通常三天后症状会明显缓解。如果明天还不见好，您可以来找我，我帮您联系医生。', highlight: true, note: '再讲理', time: '14:15:35' },
                    { role: 'user', text: '行吧，那我再吃两天看看。', time: '14:15:50' }
                ]
            }
        ];

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            renderMetrics();
            renderSupervisionTasks();
            renderHotWords();
            renderSentiments();
            renderCases();
        });

        // --- Render Functions ---
        function renderMetrics() {
            const container = document.getElementById('metrics-scroll-container');
            container.innerHTML = metricsData.map((m, idx) => {
                // 客流量卡片(idx === 0)不使用任何动画特效,保持简洁静态展示
                const activeClass = idx === 0 ? '' : 'active:scale-95';
                const hoverClass = idx === 0 ? '' : 'hover:shadow-hover';
                const transitionClass = idx === 0 ? '' : 'transition-transform';
                return `
                <div onclick="openMetricDetailView(${idx})" class="inline-block w-40 glass-panel p-3 rounded-xl ${activeClass} ${transitionClass} cursor-pointer shadow-card ${hoverClass}">
                    <div class="text-[10px] text-text-tertiary mb-1">${m.title}</div>
                    <div class="text-xl font-bold text-text-primary mb-2 font-mono">${m.value}</div>
                    <div class="flex items-center text-[10px] ${m.isUp ? 'text-success' : 'text-error'}">
                        <i class="fa-solid fa-arrow-trend-${m.isUp ? 'up' : 'down'} mr-1"></i>
                        <span>${m.changeAbs}</span>
                        <span class="ml-1 opacity-70">(${m.changeRel})</span>
                    </div>
                </div>
            `}).join('');
            // Padding right hint
            container.insertAdjacentHTML('beforeend', '<div class="inline-block w-2"></div>');
        }

        function renderSupervisionTasks() {
            const container = document.getElementById('supervision-task-list');
            container.innerHTML = supervisionTasks.map(t => `
                <div class="glass-panel p-3 rounded-lg relative group cursor-pointer active:scale-95 transition-transform hover:shadow-hover" onclick="openTaskDetailView(${t.id})">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="text-sm font-bold text-text-primary mb-1">${t.title}</h3>
                            <div class="flex items-center space-x-2">
                                <span class="text-[10px] text-text-tertiary"><i class="fa-regular fa-clock mr-1"></i>${t.createTime}</span>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button class="text-text-tertiary hover:text-primary" onclick="event.stopPropagation(); openTaskShareModal(${t.id})">
                                <i class="fa-solid fa-share-nodes text-xs"></i>
                            </button>
                            <button class="text-text-tertiary hover:text-primary" onclick="event.stopPropagation(); openEditTaskView(event, ${t.id})">
                                <i class="fa-solid fa-pen text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <div class="text-[10px] text-text-tertiary mb-0.5">昨日执行率</div>
                            <div class="text-lg font-bold text-text-primary font-mono">${t.value}</div>
                        </div>
                        <div class="text-[10px] ${t.isUp ? 'text-success' : 'text-error'}">
                            ${t.changeRel}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderHotWords() {
            const container = document.getElementById('insights-keywords');
            container.innerHTML = hotWords.map((w, idx) => {
                return `
                <div class="glass-panel rounded-lg overflow-hidden shadow-card hover:shadow-hover transition-shadow">
                    <!-- Head -->
                    <div class="flex items-center justify-between p-3">
                        <div class="flex items-center space-x-3">
                            <span class="font-mono text-sm font-bold w-4 text-center ${idx < 3 ? 'text-primary' : 'text-text-tertiary'}">${w.rank}</span>
                            <div>
                                <div class="text-sm text-text-primary font-medium flex items-center">
                                    ${w.text}
                                    <span class="ml-2 text-[10px] bg-bg-container text-text-secondary px-1.5 rounded">${w.type}</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-text-primary font-bold font-mono">${w.count}</div>
                    </div>
                </div>
            `}).join('');
        }

        function renderSentiments(filterType = 'all') {
            const container = document.getElementById('sentiment-cards-container');
            
            // Filter data based on selected type
            const filteredData = filterType === 'all' ? sentimentData : sentimentData.filter(s => s.type === filterType);
            
            container.innerHTML = filteredData.map(s => {
                // Type color mapping (only for labels)
                let typeColorClass = '';
                switch(s.type) {
                    case 'complaint':
                        typeColorClass = 'text-error bg-error-bg border-error/30';
                        break;
                    case 'dispute':
                        typeColorClass = 'text-error bg-error-bg border-error/30';
                        break;
                    case 'stock-out':
                        typeColorClass = 'text-warning-text bg-warning-bg border-warning/30';
                        break;
                    case 'quality-issue':
                        typeColorClass = 'text-error bg-error-bg border-error/30';
                        break;
                    case 'price-dispute':
                        typeColorClass = 'text-warning-text bg-warning-bg border-warning/30';
                        break;
                    case 'service-risk':
                        typeColorClass = 'text-error bg-error-bg border-error/30';
                        break;
                    case 'store-anomaly':
                        typeColorClass = 'text-warning-text bg-warning-bg border-warning/30';
                        break;
                    case 'praise':
                        typeColorClass = 'text-success bg-success-bg border-success/30';
                        break;
                }

                return `
                <div onclick="openSentimentDetailView('${s.id}')" class="glass-panel rounded-xl p-4 relative cursor-pointer active:scale-95 transition-transform hover:shadow-hover">
                    <!-- Type & Priority -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-bold px-2.5 py-1 rounded-full border ${typeColorClass}">${s.typeText}</span>
                        </div>
                        <span class="text-[10px] text-text-tertiary">${s.time.split(' ')[1]}</span>
                    </div>

                    <!-- Title -->
                    <h3 class="text-sm font-bold text-text-primary mb-2">${s.title}</h3>

                    <!-- Summary -->
                    <p class="text-xs text-text-secondary leading-relaxed mb-3 line-clamp-2">${s.summary}</p>

                    <!-- Meta Info -->
                    <div class="flex items-center justify-between pt-2 border-t border-border-light">
                        <div class="flex items-center space-x-3 text-[10px] text-text-tertiary">
                            <span><i class="fa-solid fa-store mr-1"></i>${s.store}</span>
                            <span><i class="fa-solid fa-user mr-1"></i>${s.staff.name}</span>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xs text-text-tertiary"></i>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderCases() {
            const container = document.getElementById('cases-list');
            container.innerHTML = casesData.map(c => `
                <div onclick="openCaseDetailView('${c.id}')" class="glass-panel rounded-xl p-4 relative group cursor-pointer active:scale-95 transition-transform hover:shadow-hover">
                    <div class="flex justify-between items-start mb-3">
                         <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-bg-container overflow-hidden border border-border-base">
                                <img src="https://i.pravatar.cc/150?u=${c.id}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="text-sm font-bold text-text-primary">${c.name}</div>
                                <div class="text-[10px] text-text-tertiary">${c.store}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-primary-1 rounded-lg p-3 mb-3 border-l-2 border-primary">
                        <div class="flex items-center space-x-2 mb-1">
                             <span class="text-[10px] bg-primary/10 text-primary px-1.5 py-0.5 rounded font-bold">${c.tag}</span>
                             <span class="text-[10px] text-text-tertiary">亮点点评</span>
                        </div>
                        <div class="text-xs text-text-primary leading-relaxed font-medium line-clamp-2">
                            ${c.reason}
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-border-light">
                        <div class="text-[10px] text-text-tertiary">
                            会话时间 <span class="text-text-primary font-mono ml-1">${c.startTime}</span>
                        </div>
                         <div class="text-[10px] text-text-tertiary">
                            时长 <span class="text-text-primary font-mono ml-1">${c.duration}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // --- Sentiment Filter Logic ---
        function filterSentiments(type) {
            // Update active button state
            const filterButtons = {
                'all': 'filter-all',
                'complaint': 'filter-complaint',
                'dispute': 'filter-dispute',
                'stock-out': 'filter-stock-out',
                'quality-issue': 'filter-quality-issue',
                'price-dispute': 'filter-price-dispute',
                'service-risk': 'filter-service-risk',
                'store-anomaly': 'filter-store-anomaly',
                'praise': 'filter-praise'
            };
            
            // Color mapping for active states
            const activeColors = {
                'all': { bg: 'bg-primary-1', text: 'text-primary', border: 'border-primary/30' },
                'complaint': { bg: 'bg-error-bg', text: 'text-error', border: 'border-error/30' },
                'dispute': { bg: 'bg-error-bg', text: 'text-error', border: 'border-error/30' },
                'stock-out': { bg: 'bg-warning-bg', text: 'text-warning-text', border: 'border-warning/30' },
                'quality-issue': { bg: 'bg-error-bg', text: 'text-error', border: 'border-error/30' },
                'price-dispute': { bg: 'bg-warning-bg', text: 'text-warning-text', border: 'border-warning/30' },
                'service-risk': { bg: 'bg-error-bg', text: 'text-error', border: 'border-error/30' },
                'store-anomaly': { bg: 'bg-warning-bg', text: 'text-warning-text', border: 'border-warning/30' },
                'praise': { bg: 'bg-success-bg', text: 'text-success', border: 'border-success/30' }
            };

            // Reset all buttons to inactive state
            Object.values(filterButtons).forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.className = 'px-3 py-1.5 text-xs font-medium rounded-full bg-transparent text-text-tertiary border border-border-base transition-all';
            });

            // Set active button
            const activeBtn = document.getElementById(filterButtons[type]);
            const colors = activeColors[type];
            activeBtn.className = `px-3 py-1.5 text-xs font-medium rounded-full ${colors.bg} ${colors.text} border ${colors.border} transition-all`;

            // Re-render sentiments with filter
            renderSentiments(type);
        }

        // --- Insights Sub-Tab Logic ---
        function switchInsightsSubTab(tab) {
            // Update buttons
            const keywordsBtn = document.getElementById('tab-insights-keywords');
            const sentimentBtn = document.getElementById('tab-insights-sentiment');
            const keywordsPanel = document.getElementById('insights-keywords');
            const sentimentPanel = document.getElementById('insights-sentiment');

            if (tab === 'keywords') {
                keywordsBtn.classList.add('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                keywordsBtn.classList.remove('text-text-tertiary', 'bg-transparent');
                sentimentBtn.classList.remove('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                sentimentBtn.classList.add('text-text-tertiary', 'bg-transparent');
                keywordsPanel.classList.remove('hidden');
                sentimentPanel.classList.add('hidden');
            } else {
                sentimentBtn.classList.add('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                sentimentBtn.classList.remove('text-text-tertiary', 'bg-transparent');
                keywordsBtn.classList.remove('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                keywordsBtn.classList.add('text-text-tertiary', 'bg-transparent');
                sentimentPanel.classList.remove('hidden');
                keywordsPanel.classList.add('hidden');
            }
        }

        // --- Sentiment Detail Logic ---
        let currentSentimentId = null;

        function openSentimentDetailView(sentimentId) {
            const s = sentimentData.find(x => x.id === sentimentId);
            if (!s) return;
            currentSentimentId = sentimentId;

            // Type color mapping
            let typeColorClass = '';
            switch(s.type) {
                case 'complaint':
                    typeColorClass = 'bg-error-bg text-error border-error/30';
                    break;
                case 'dispute':
                    typeColorClass = 'bg-error-bg text-error border-error/30';
                    break;
                case 'stock-out':
                    typeColorClass = 'bg-warning-bg text-warning-text border-warning/30';
                    break;
                case 'quality-issue':
                    typeColorClass = 'bg-error-bg text-error border-error/30';
                    break;
                case 'price-dispute':
                    typeColorClass = 'bg-warning-bg text-warning-text border-warning/30';
                    break;
                case 'service-risk':
                    typeColorClass = 'bg-error-bg text-error border-error/30';
                    break;
                case 'store-anomaly':
                    typeColorClass = 'bg-warning-bg text-warning-text border-warning/30';
                    break;
                case 'praise':
                    typeColorClass = 'bg-success-bg text-success border-success/30';
                    break;
            }

            // Populate Data
            document.getElementById('sentiment-type-tag').className = `text-xs font-bold px-3 py-1 rounded-full border ${typeColorClass}`;
            document.getElementById('sentiment-type-tag').innerText = s.typeText;
            document.getElementById('sentiment-priority').innerText = s.priority === 'high' ? s.priorityIcon : '';
            document.getElementById('sentiment-title').innerText = s.title;
            document.getElementById('sentiment-time').innerText = s.time;
            document.getElementById('sentiment-store').innerText = s.store;
            document.getElementById('sentiment-staff-avatar').src = s.staff.avatar;
            document.getElementById('sentiment-staff-name').innerText = s.staff.name;
            document.getElementById('sentiment-summary').innerText = s.summary;

            // Transcript
            const transcriptContainer = document.getElementById('sentiment-transcript');
            transcriptContainer.innerHTML = s.transcript.map(msg => {
                const isStaff = msg.role === 'staff';
                const alignClass = isStaff ? 'justify-end' : 'justify-start';
                const bubbleClass = isStaff ? 'bg-primary-1 text-text-primary rounded-tr-none border border-primary/20' : 'bg-bg-container text-text-secondary rounded-tl-none border border-border-base';

                return `
                    <div class="flex ${alignClass}">
                        <div class="max-w-[80%] p-3 rounded-2xl text-xs leading-relaxed ${bubbleClass}">
                            <div class="text-[9px] text-text-tertiary mb-1">${isStaff ? '店员' : '顾客'} ${msg.time}</div>
                            ${msg.text}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('sentiment-detail-view').classList.remove('translate-x-full');
        }

        function hideSentimentDetailView() {
            document.getElementById('sentiment-detail-view').classList.add('translate-x-full');
        }

        // --- Sentiment Share Modal Logic ---
        function openSentimentShareModal() {
            const s = sentimentData.find(x => x.id === currentSentimentId);
            if (!s) return;

            // Type color mapping
            let typeColorClass = '';
            switch(s.type) {
                case 'complaint':
                    typeColorClass = 'bg-error-bg text-error border-error/30 border';
                    break;
                case 'dispute':
                    typeColorClass = 'bg-error-bg text-error border-error/30 border';
                    break;
                case 'stock-out':
                    typeColorClass = 'bg-warning-bg text-warning-text border-warning/30 border';
                    break;
                case 'quality-issue':
                    typeColorClass = 'bg-error-bg text-error border-error/30 border';
                    break;
                case 'price-dispute':
                    typeColorClass = 'bg-warning-bg text-warning-text border-warning/30 border';
                    break;
                case 'service-risk':
                    typeColorClass = 'bg-error-bg text-error border-error/30 border';
                    break;
                case 'store-anomaly':
                    typeColorClass = 'bg-warning-bg text-warning-text border-warning/30 border';
                    break;
                case 'praise':
                    typeColorClass = 'bg-success-bg text-success border-success/30 border';
                    break;
            }

            document.getElementById('poster-sentiment-type').className = `inline-block px-3 py-1 rounded-full text-xs font-bold ${typeColorClass}`;
            document.getElementById('poster-sentiment-type').innerText = s.typeText;
            document.getElementById('poster-sentiment-priority').innerText = s.priority === 'high' ? s.priorityIcon : '';
            document.getElementById('poster-sentiment-time').innerText = s.time;
            document.getElementById('poster-sentiment-title').innerText = s.title;
            document.getElementById('poster-sentiment-avatar').src = s.staff.avatar;
            document.getElementById('poster-sentiment-staff').innerText = s.staff.name;
            document.getElementById('poster-sentiment-store').innerText = s.store;
            document.getElementById('poster-sentiment-summary').innerText = s.summary;

            // Select key transcript (first 3 messages)
            const keyTranscript = s.transcript.slice(0, 3);
            const transcriptContainer = document.getElementById('poster-sentiment-transcript');
            transcriptContainer.innerHTML = keyTranscript.map(t => `
                <div class="flex items-start space-x-2">
                    <div class="font-bold text-text-tertiary flex-shrink-0">${t.role === 'staff' ? '店员' : '顾客'}:</div>
                    <div>${t.text}</div>
                </div>
            `).join('');

            document.getElementById('share-sentiment-modal').classList.remove('hidden');
        }

        function closeSentimentShareModal() {
            document.getElementById('share-sentiment-modal').classList.add('hidden');
        }

        // --- Case Detail Logic ---
        let currentCaseId = null;

        function openCaseDetailView(caseId) {
             const c = casesData.find(x => x.id === caseId);
             if (!c) return;
             currentCaseId = caseId;

             // Populate Data
             document.getElementById('case-detail-name').innerText = c.name;
             document.getElementById('case-detail-store').innerText = c.store;
             document.getElementById('case-detail-avatar').src = `https://i.pravatar.cc/150?u=${c.id}`;
             document.getElementById('case-detail-tag').innerText = '#' + c.tag;
             document.getElementById('case-detail-reason').innerText = c.reason;

             // Transcript
             const list = document.getElementById('case-transcript-list');
             list.innerHTML = c.transcript.map(msg => {
                 const isStaff = msg.role === 'staff';
                 const alignClass = isStaff ? 'justify-end' : 'justify-start';
                 const bubbleClass = isStaff ? 'bg-primary-1 text-text-primary rounded-tr-none border border-primary/20' : 'bg-bg-container text-text-secondary rounded-tl-none border border-border-base';

                 return `
                    <div class="flex flex-col ${isStaff ? 'items-end' : 'items-start'} mb-4">
                        <div class="flex ${alignClass} mb-1">
                            ${!isStaff ? '<div class="w-6 h-6 rounded-full bg-bg-hover flex-shrink-0 mr-2 flex items-center justify-center text-[10px] text-text-tertiary"><i class="fa-solid fa-user"></i></div>' : ''}
                            <div class="max-w-[80%] p-3 rounded-2xl text-xs leading-relaxed ${bubbleClass}">
                                ${msg.text}
                            </div>
                            ${isStaff ? `<div class="w-6 h-6 rounded-full bg-bg-container flex-shrink-0 ml-2 overflow-hidden border border-border-base"><img src="https://i.pravatar.cc/150?u=${c.id}" class="w-full h-full"></div>` : ''}
                        </div>
                        <div class="text-[9px] text-text-disabled px-10 font-mono">${msg.time}</div>
                    </div>
                 `;
             }).join('');

             document.getElementById('case-detail-view').classList.remove('translate-x-full');
        }

        function hideCaseDetailView() {
            document.getElementById('case-detail-view').classList.add('translate-x-full');
        }

        // --- Interaction Logic ---
        function switchHomeTab(tab) {
            // Update Headers
            ['supervision', 'insights', 'cases'].forEach(t => {
                const btn = document.getElementById(`tab-home-${t}`);
                const panel = document.getElementById(`panel-home-${t}`);
                if (t === tab) {
                    btn.classList.add('text-primary', 'border-primary');
                    btn.classList.remove('text-text-tertiary', 'border-transparent');
                    panel.classList.remove('hidden');
                } else {
                    btn.classList.remove('text-primary', 'border-primary');
                    btn.classList.add('text-text-tertiary', 'border-transparent');
                    panel.classList.add('hidden');
                }
            });
        }


        // --- Metric Detail Logic ---
        let metricDetailChart = null;
        let currentMetricIndex = null;
        let currentTrendType = '7days'; // '7days' or 'hourly'

        // Mock 7-day trend data for each metric
        const metricTrendData = {
            0: { // 客流量
                labels: ['01-07', '01-08', '01-09', '01-10', '01-11', '01-12', '01-13'],
                data: [1180, 1210, 1195, 1230, 1220, 1200, 1250],
                unit: '人'
            },
            1: { // 工牌使用率
                labels: ['01-07', '01-08', '01-09', '01-10', '01-11', '01-12', '01-13'],
                data: [78, 80, 82, 80, 83, 80, 85],
                unit: '%'
            },
            2: { // 平均使用时长
                labels: ['01-07', '01-08', '01-09', '01-10', '01-11', '01-12', '01-13'],
                data: [7.5, 7.6, 7.8, 7.4, 7.5, 7.7, 7.2],
                unit: 'h'
            }
        };

        // Mock hourly trend data for yesterday (every 3 hours)
        const metricHourlyData = {
            0: { // 客流量
                labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
                data: [12, 8, 15, 125, 180, 210, 165, 85],
                unit: '人'
            },
            1: { // 工牌使用率
                labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
                data: [0, 0, 15, 85, 95, 92, 88, 45],
                unit: '%'
            },
            2: { // 平均使用时长
                labels: ['00:00', '03:00', '06:00', '09:00', '12:00', '15:00', '18:00', '21:00'],
                data: [0, 0, 0.5, 3.5, 5.2, 6.8, 7.2, 4.5],
                unit: 'h'
            }
        };

        // Mock store ranking data for each metric
        const metricStoreData = {
            0: [ // 客流量
                { name: '中心广场店', value: '298人' },
                { name: '滨江路分店', value: '265人' },
                { name: '体育馆店', value: '242人' },
                { name: '大学城店', value: '210人' },
                { name: '老城区店', value: '188人' },
                { name: '高新区店', value: '47人' }
            ],
            1: [ // 工牌使用率
                { name: '体育馆店', value: '96%' },
                { name: '中心广场店', value: '92%' },
                { name: '滨江路分店', value: '88%' },
                { name: '高新区店', value: '76%' },
                { name: '大学城店', value: '65%' },
                { name: '老城区店', value: '58%' }
            ],
            2: [ // 平均使用时长
                { name: '中心广场店', value: '8.5h' },
                { name: '滨江路分店', value: '8.2h' },
                { name: '体育馆店', value: '7.6h' },
                { name: '高新区店', value: '7.1h' },
                { name: '大学城店', value: '6.5h' },
                { name: '老城区店', value: '5.8h' }
            ]
        };

        function openMetricDetailView(metricIndex) {
            const metric = metricsData[metricIndex];
            if (!metric) return;
            
            currentMetricIndex = metricIndex;
            currentTrendType = '7days'; // Reset to default

            // Fill Basic Info
            document.getElementById('metric-detail-title').innerText = metric.title;
            document.getElementById('metric-detail-value').innerText = metric.value;
            
            // Fill Change Info
            const changeEl = document.getElementById('metric-detail-change');
            const colorClass = metric.isUp ? 'text-success' : 'text-error';
            const iconClass = metric.isUp ? 'up' : 'down';
            changeEl.className = `flex items-center justify-center text-sm ${colorClass}`;
            changeEl.innerHTML = `
                <i class="fa-solid fa-arrow-trend-${iconClass} mr-2"></i>
                <span>${metric.changeAbs}</span>
                <span class="ml-2 opacity-70">(${metric.changeRel})</span>
            `;

            // Show warning for Traffic metric
            const warningEl = document.getElementById('metric-warning');
            if (metricIndex === 0) { // 客流量
                warningEl.classList.remove('hidden');
            } else {
                warningEl.classList.add('hidden');
            }

            // Show/Hide trend switch buttons (Only for Traffic - index 0)
            const trendSwitchContainer = document.getElementById('trend-switch-container');
            const chartTitleEl = document.getElementById('metric-chart-title');
            
            if (metricIndex === 0) { // 客流量 - Show switch buttons
                trendSwitchContainer.classList.remove('hidden');
                trendSwitchContainer.classList.add('flex');
                chartTitleEl.innerText = '趋势分析';
                
                // Reset trend buttons to default (7days)
                const btn7days = document.getElementById('btn-trend-7days');
                const btnHourly = document.getElementById('btn-trend-hourly');
                btn7days.classList.add('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                btn7days.classList.remove('text-text-tertiary', 'bg-transparent');
                btnHourly.classList.remove('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                btnHourly.classList.add('text-text-tertiary', 'bg-transparent');
            } else { // 其他指标 - Hide switch buttons, show simple title
                trendSwitchContainer.classList.add('hidden');
                trendSwitchContainer.classList.remove('flex');
                chartTitleEl.innerText = '近7日趋势';
            }

            // Render Chart with default trend type
            renderMetricChart(metricIndex, currentTrendType);

            // Render Store List
            renderMetricStoreList(metricIndex);

            document.getElementById('metric-detail-view').classList.remove('translate-x-full');
        }

        function hideMetricDetailView() {
            document.getElementById('metric-detail-view').classList.add('translate-x-full');
        }

        function switchMetricTrend(trendType) {
            // Only allow switch for Traffic metric (index 0)
            if (currentMetricIndex !== 0) return;
            
            // Update button states
            const btn7days = document.getElementById('btn-trend-7days');
            const btnHourly = document.getElementById('btn-trend-hourly');
            
            if (trendType === '7days') {
                btn7days.classList.add('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                btn7days.classList.remove('text-text-tertiary', 'bg-transparent');
                btnHourly.classList.remove('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                btnHourly.classList.add('text-text-tertiary', 'bg-transparent');
            } else {
                btnHourly.classList.add('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                btnHourly.classList.remove('text-text-tertiary', 'bg-transparent');
                btn7days.classList.remove('text-primary', 'bg-primary-1', 'border', 'border-primary/30');
                btn7days.classList.add('text-text-tertiary', 'bg-transparent');
            }
            
            // Update current trend type and re-render chart
            currentTrendType = trendType;
            renderMetricChart(currentMetricIndex, currentTrendType);
        }

        function renderMetricChart(metricIndex, trendType = '7days') {
            const ctx = document.getElementById('metric-detail-chart').getContext('2d');
            if (metricDetailChart) metricDetailChart.destroy();

            // Select data source based on trend type
            const trendData = trendType === '7days' ? metricTrendData[metricIndex] : metricHourlyData[metricIndex];
            if (!trendData) return;

            metricDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: metricsData[metricIndex].title,
                        data: trendData.data,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-blue').trim(),
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-tertiary').trim(), 
                                font: { size: 10 } 
                            }
                        },
                        y: {
                            grid: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-split').trim() 
                            },
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-tertiary').trim(), 
                                font: { size: 10 },
                                callback: function(value) {
                                    return value + trendData.unit;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMetricStoreList(metricIndex) {
            const list = document.getElementById('metric-store-list');
            const stores = metricStoreData[metricIndex];
            if (!stores) return;

            list.innerHTML = stores.map((s, idx) => {
                let colorClass = 'text-text-primary';
                if (idx < 3) {
                    colorClass = 'text-success'; // Top 3
                } else if (idx >= stores.length - 2) {
                    colorClass = 'text-error'; // Bottom 2
                } else {
                    colorClass = 'text-primary'; // Others
                }
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-border-base shadow-sm">
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-text-tertiary w-4 font-mono">${idx + 1}</span>
                            <span class="text-sm text-text-primary">${s.name}</span>
                        </div>
                        <span class="text-sm font-bold font-mono ${colorClass}">${s.value}</span>
                    </div>
                `;
            }).join('');
        }

        // --- View Transitions ---
        function openCreateTaskView() {
            // Reset to Create Mode
            document.getElementById('create-task-title').innerText = '新建任务';
            document.getElementById('ai-input-section').classList.remove('hidden');
            document.getElementById('generated-result-area').classList.add('hidden');
            document.getElementById('btn-initial-generate').classList.remove('hidden');
            document.getElementById('btn-group-generated').classList.add('hidden');
            document.getElementById('btn-group-generated').classList.remove('flex');
            
            // Clear inputs
            document.getElementById('ai-input-desc').value = '';
            document.getElementById('task-name').value = '';
            document.getElementById('task-intro').value = '';
            document.getElementById('task-action').value = '';

            document.getElementById('create-task-view').classList.remove('translate-x-full');
        }

        function openEditTaskView(event, taskId) {
            event.stopPropagation(); // Prevent card click
            const task = supervisionTasks.find(t => t.id === taskId);
            if (!task) return;

            // Set to Edit Mode
            document.getElementById('create-task-title').innerText = '编辑任务';
            document.getElementById('ai-input-section').classList.add('hidden');
            document.getElementById('generated-result-area').classList.remove('hidden');
            document.getElementById('btn-initial-generate').classList.add('hidden');
            document.getElementById('btn-group-generated').classList.remove('hidden');
            document.getElementById('btn-group-generated').classList.add('flex');
            
            document.getElementById('btn-save-task').innerHTML = '<i class="fa-solid fa-check mr-1"></i> 保存修改';

            // Fill Data
            document.getElementById('task-name').value = task.title;
            document.getElementById('task-intro').value = task.desc + " (此处为详细描述...)";
            document.getElementById('task-action').value = "话术建议：请根据实际情况进行推荐...";

            // Update character counts
            updateCharCount('task-name', 20);
            updateCharCount('task-intro', 100);
            updateCharCount('task-action', 200);

            document.getElementById('create-task-view').classList.remove('translate-x-full');
        }

        function hideCreateTaskView() {
            document.getElementById('create-task-view').classList.add('translate-x-full');
        }

        // --- Task Detail View Logic ---
        let detailChart = null;
        let currentDetailTaskId = null;

        function openTaskDetailView(taskId) {
            const task = supervisionTasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentDetailTaskId = taskId;

            // Fill Basic Info
            document.getElementById('detail-task-title').innerText = task.title;
            document.getElementById('detail-task-value').innerText = task.value;
            document.getElementById('detail-task-intro').innerText = task.desc + "。该指标用于检测店员在接待过程中是否按照公司规定执行了标准动作。";
            document.getElementById('detail-task-action').innerText = "1. 询问顾客需求。\n2. 针对性推荐相关产品。\n3. 提醒用法用量。\n(话术示例：搭配这个效果更好...)";

            // Render Chart
            renderDetailChart();

            // Render Store List
            renderStoreList();

            document.getElementById('task-detail-view').classList.remove('translate-x-full');
        }

        function hideTaskDetailView() {
            document.getElementById('task-detail-view').classList.add('translate-x-full');
        }

        function renderDetailChart() {
            const ctx = document.getElementById('detail-task-chart').getContext('2d');
            if (detailChart) detailChart.destroy();

            // Mock Data
            const labels = ['01-07', '01-08', '01-09', '01-10', '01-11', '01-12', '01-13'];
            const data = [65, 68, 62, 70, 72, 69, 75];

            detailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '执行率',
                        data: data,
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-blue').trim(),
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-tertiary').trim(), 
                                font: { size: 10 } 
                            }
                        },
                        y: {
                            grid: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-split').trim() 
                            },
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-tertiary').trim(), 
                                font: { size: 10 } 
                            },
                            min: 50,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderStoreList() {
            const list = document.getElementById('detail-store-list');
            // Mock Stores
            const stores = [
                { name: '中心广场店', rate: '92%', status: 'high' },
                { name: '滨江路分店', rate: '88%', status: 'high' },
                { name: '体育馆店', rate: '76%', status: 'mid' },
                { name: '大学城店', rate: '65%', status: 'low' },
                { name: '老城区店', rate: '58%', status: 'low' },
            ];

            list.innerHTML = stores.map((s, idx) => {
                let colorClass = s.status === 'high' ? 'text-success' : (s.status === 'mid' ? 'text-primary' : 'text-error');
                return `
                    <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-border-base shadow-sm">
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-text-tertiary w-4 font-mono">${idx + 1}</span>
                            <span class="text-sm text-text-primary">${s.name}</span>
                        </div>
                        <span class="text-sm font-bold font-mono ${colorClass}">${s.rate}</span>
                    </div>
                `;
            }).join('');
        }

        // --- Character Count Update ---
        function updateCharCount(fieldId, maxLength) {
            const field = document.getElementById(fieldId);
            const countSpan = document.getElementById(fieldId + '-count');
            if (countSpan) {
                const currentLength = field.value.length;
                const colorClass = currentLength >= maxLength ? 'text-neon-red' : 'text-neon-blue';
                countSpan.innerHTML = `<span class="${colorClass}">${currentLength}</span>/${maxLength}`;
            }
        }

        // --- AI Interaction & Task Creation ---
        
        // Update input character count
        function updateInputCharCount() {
            const input = document.getElementById('ai-input-desc');
            const countSpan = document.getElementById('ai-input-count');
            const clearBtn = document.getElementById('btn-clear-input');
            const currentLength = input.value.length;
            const maxLength = 200;
            
            // Update count display
            const colorClass = currentLength >= maxLength ? 'text-error' : 'text-primary';
            countSpan.innerHTML = `<span class="${colorClass}">${currentLength}</span>/${maxLength}`;
            
            // Show/hide clear button
            if (currentLength > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
        
        // Clear input
        function clearInput() {
            const input = document.getElementById('ai-input-desc');
            const voiceWarning = document.getElementById('voice-warning');
            
            input.value = '';
            updateInputCharCount();
            voiceWarning.classList.add('hidden');
        }
        
        // Voice input functionality
        let recognition = null;
        let isVoiceInputActive = false;
        
        function startVoiceInput() {
            const input = document.getElementById('ai-input-desc');
            const btn = document.getElementById('btn-voice-input');
            const voiceWarning = document.getElementById('voice-warning');
            
            // Check browser support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('您的浏览器不支持语音识别功能，请使用Chrome、Edge等现代浏览器。');
                return;
            }
            
            // Stop recording if already active
            if (isVoiceInputActive && recognition) {
                recognition.stop();
                return;
            }
            
            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            let finalTranscript = input.value; // Start with existing text
            
            recognition.onstart = function() {
                isVoiceInputActive = true;
                btn.classList.add('bg-error', 'text-white', 'animate-pulse');
                btn.classList.remove('bg-primary-1', 'text-primary');
                voiceWarning.classList.add('hidden');
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const combinedText = finalTranscript + interimTranscript;
                
                // Check character limit
                if (combinedText.length > 200) {
                    // Truncate to 200 characters
                    finalTranscript = combinedText.substring(0, 200);
                    input.value = finalTranscript;
                    updateInputCharCount();
                    
                    // Show warning
                    voiceWarning.classList.remove('hidden');
                    
                    // Stop recognition
                    recognition.stop();
                } else {
                    input.value = combinedText;
                    updateInputCharCount();
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMsg = '语音识别出错，请重试。';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = '未检测到语音，请重试。';
                        break;
                    case 'audio-capture':
                        errorMsg = '无法访问麦克风，请检查权限设置。';
                        break;
                    case 'not-allowed':
                        errorMsg = '麦克风权限被拒绝，请在浏览器设置中允许访问。';
                        break;
                }
                
                alert(errorMsg);
                resetVoiceButton();
            };
            
            recognition.onend = function() {
                resetVoiceButton();
            };
            
            // Start recognition
            try {
                recognition.start();
            } catch (e) {
                console.error('Failed to start speech recognition:', e);
                alert('语音识别启动失败，请重试。');
                resetVoiceButton();
            }
        }
        
        function resetVoiceButton() {
            const btn = document.getElementById('btn-voice-input');
            isVoiceInputActive = false;
            btn.classList.remove('bg-error', 'text-white', 'animate-pulse');
            btn.classList.add('bg-primary-1', 'text-primary');
        }
        
        function fillInput(text) {
            document.getElementById('ai-input-desc').value = text;
            updateInputCharCount();
        }

        function triggerGenerate() {
            const btn = document.getElementById('btn-initial-generate');
            const resultArea = document.getElementById('generated-result-area');
            const btnGroup = document.getElementById('btn-group-generated');
            const inputDesc = document.getElementById('ai-input-desc').value;

            // Loading
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 生成中...';
            btn.disabled = true;

            setTimeout(() => {
                // Show results
                resultArea.classList.remove('hidden');
                
                // Switch Buttons
                btn.classList.add('hidden');
                btnGroup.classList.remove('hidden');
                btnGroup.classList.add('flex');

                // Fill Mock Data
                document.getElementById('task-name').value = "流感季关联维C推广";
                document.getElementById('task-intro').value = "检测店员在销售感冒药（如感冒灵、布洛芬）时，是否主动推荐了维生素C或泡腾片。";
                document.getElementById('task-action').value = "话术建议：“搭配一瓶维生素C，增强抵抗力好得快。”";

                // Update character counts
                updateCharCount('task-name', 20);
                updateCharCount('task-intro', 100);
                updateCharCount('task-action', 200);

                // Scroll to bottom
                document.getElementById('create-task-body').scrollTo({ top: 1000, behavior: 'smooth' });
                
                // Reset Button State (in case we go back)
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1000);
        }

        function regenerateField(fieldId) {
            const field = document.getElementById(fieldId);
            field.parentNode.classList.add('opacity-50');
            setTimeout(() => {
                field.parentNode.classList.remove('opacity-50');
                if(fieldId === 'task-name') {
                    field.value = "感冒药关联销售合规检查";
                    updateCharCount('task-name', 20);
                }
                if(fieldId === 'task-intro') {
                    field.value = "监控是否在顾客购买抗病毒药物时，进行了免疫力产品的关联推荐。";
                    updateCharCount('task-intro', 100);
                }
                if(fieldId === 'task-action') {
                    field.value = "SOP：1.询问症状 2.推荐主药 3.关联维C/益生菌";
                    updateCharCount('task-action', 200);
                }
            }, 500);
        }

        function resetGenerate() {
            // Hide results
            document.getElementById('generated-result-area').classList.add('hidden');
            // Reset Buttons
            document.getElementById('btn-initial-generate').classList.remove('hidden');
            document.getElementById('btn-group-generated').classList.add('hidden');
            document.getElementById('btn-group-generated').classList.remove('flex');
            // Clear inputs (optional)
            // document.getElementById('ai-input-desc').value = '';
        }

        function saveNewTask() {
            hideCreateTaskView();
            // Reset view for next time
            setTimeout(() => {
                resetGenerate();
                document.getElementById('ai-input-desc').value = '';
                alert('任务已创建并生效');
            }, 300);
        }

        function switchMainTab(tab) {
             const dashboardView = document.getElementById('dashboard-view');
             const profileView = document.getElementById('profile-view');
             const navDashboard = document.getElementById('nav-item-dashboard');
             const navProfile = document.getElementById('nav-item-profile');
             
             if(tab === 'dashboard') {
                 // Show Dashboard
                 dashboardView.classList.remove('hidden');
                 profileView.classList.add('hidden');
                 
                 // Update Navigation
                 navDashboard.classList.add('text-primary');
                 navDashboard.classList.remove('text-text-tertiary');
                 navProfile.classList.add('text-text-tertiary');
                 navProfile.classList.remove('text-primary');
             } else if(tab === 'profile') {
                 // Show Profile
                 dashboardView.classList.add('hidden');
                 profileView.classList.remove('hidden');
                 
                 // Update Navigation
                 navDashboard.classList.remove('text-primary');
                 navDashboard.classList.add('text-text-tertiary');
                 navProfile.classList.remove('text-text-tertiary');
                 navProfile.classList.add('text-primary');
             }
        }
        
        function handleLogout() {
            if(confirm('确定要退出登录吗？')) {
                alert('已退出登录');
                // Here you would typically redirect to login page or clear auth tokens
            }
        }

        // --- Share Modal Logic (Task) ---
        function openTaskShareModal(taskId) {
            const task = supervisionTasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('poster-task-title').innerText = task.title;
            // Mock dynamic SOP based on task description or separate field
            document.getElementById('poster-task-desc').innerText = "1. 询问顾客需求。\n2. 针对性推荐相关产品。\n3. 提醒用法用量。\n(话术示例：搭配这个效果更好...)"; 
            document.getElementById('poster-create-time').innerText = task.createTime || '2026-01-13';
            
            document.getElementById('share-task-modal').classList.remove('hidden');
        }

        function closeTaskShareModal() {
            document.getElementById('share-task-modal').classList.add('hidden');
        }

        // --- Share Modal Logic (Case) ---
        function openCaseShareModal() {
            const c = casesData.find(x => x.id === currentCaseId);
            if (!c) return;

            document.getElementById('poster-case-name').innerText = c.name;
            document.getElementById('poster-case-store').innerText = c.store;
            document.getElementById('poster-case-avatar').src = `https://i.pravatar.cc/150?u=${c.id}`;
            document.getElementById('poster-case-duration').innerText = c.duration;
            document.getElementById('poster-case-reason').innerText = c.reason;
            document.getElementById('poster-case-time').innerText = c.startTime;

            // Display complete conversation transcript (all messages)
            const transcriptContainer = document.getElementById('poster-case-transcript');
            transcriptContainer.innerHTML = c.transcript.map(t => `
                <div class="flex items-start space-x-2 mb-2">
                    <div class="font-bold ${t.role === 'staff' ? 'text-primary' : 'text-text-tertiary'} flex-shrink-0">${t.role === 'staff' ? '店员' : '顾客'}:</div>
                    <div class="flex-1">${t.text}</div>
                </div>
            `).join('');

            document.getElementById('share-case-modal').classList.remove('hidden');
        }

        function closeCaseShareModal() {
            document.getElementById('share-case-modal').classList.add('hidden');
        }

        function downloadPoster() {
            alert('正在生成海报图片并保存到本地...');
        }

        function shareToWeChat() {
            alert('即将打开微信联系人列表...');
        }
    </script>
</body>
</html>
